---
title: "Processing Terrestrial Ecoregions of the World(TEOW)"
author: "Johannes Schielein, Om Prakash Bhandari"
date: "3/12/2021"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_knit$set(root.dir = '../')
# load required libraries
library("sf")
library("wdpar")
library("dplyr")
library("rmarkdown") # only used for rendering tables  for this website
starttime<-Sys.time()
```


# Introduction

Terrestrial Ecoregions of the World (TEOW) is a biogeographic regionalization of the Earth's terrestrial biodiversity. Our biogeographic units are ecoregions, which are defined as relatively large units of land or inland water containing a distinct assemblage of natural communities sharing a large majority of species, dynamics, and environmental conditions. There are 867 terrestrial ecoregions, classified into 14 different biomes such as forests, grasslands, or deserts. Ecoregions represent the original distribution of distinct assemblages of species and communities.Visit [Link]("https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world") for more information on TEOW from WWF.

### Datasource and Metadata Information

- Dataset: Terrestrial Ecoregions of the World - World Wildlife Fund [1]
- Geographical Coverage: Global
- Temporal Coverage: 2001
- Temporal Resolution: Cross-sectional
- Unit: hectare
- Data downloaded: 15th March, 2021
- [Metadata Link]("https://stuff.mit.edu/afs/athena/course/11/11.951/ecoplan/data/ecoregions/wwf_terr_ecos.htm")
- [Download Link]("https://globil-panda.opendata.arcgis.com/datasets/terrestrial-ecoregions-world")


Here we are going to carry out an analysis to see the level of intersection of different WDPA polygon layers with the Ecoregions; to answer how much area of wdpa polygon is within a particular type of biomes.

### Processing Workflow

To carry out this analysis, we will follow this processing routine:

- fetch country level WDPA polygon from `wdpar`
- select desired wdpa polygon from `wdpar` and clean the data
- load archived global TEOW polygon
- simplify the TEOW polygon
- generate projstring using `area_proj` function & transform the projection system of polygons
- intersect TEOW and polygon layer
- extract areas of the intersection
- for each wdpaid, get name of the biomes and area of intersected polygons


```{r workflow, echo=FALSE, fig.cap="TEOW Processing Workflow"}

knitr::include_graphics("../docs/workflows/teow_intersection_routine.png")
```

# Download and prepare WDPA polygons 

First of all, we will try to get the country level polygon data from `wdpar` package. `wdpar` is a library to interface to the World Database on Protected Areas (WDPA). The library is used to monitor the performance of existing PAs and determine priority areas for the establishment of new PAs. We will use Brazil - for other countries of your choice, simply provide the country name or the ISO3 name e.g. Gy for Guyana, COL for Colombia

```{r fetchWdpar, warning=FALSE, include=TRUE}
# fetch the raw data from wdpar of country
br_wdpa_raw <- wdpa_fetch("Brazil")
```

Since there are more than 3000 enlisted protected areas in Brazil, we are interested in only three wdpa polygons:
  - Reserva Biologica Do Rio Trombetas - wdpaid 43,
	- Reserva Extrativista Rio Cajari - wdpaid 31776, and
	- Estacao Ecologica Do Jari - wdpaid 4891

For this, we have to subset the country level polygon data to the PAs level.

```{r subset, warning=FALSE, include=TRUE}

# subset three wdpa polygons by their wdpa ids
br_wdpa_subset<-
  br_wdpa_raw%>%
  filter(WDPAID %in% c(43,4891,31776))
```

The next immediate step would be to clean the fetched raw data with the functionality provided with routines from the `wdpar` package. Cleaning is done so as to:

- exclude protected areas that are not yet implemented
- exclude protected areas that are UNESCO reserves
- removing points with no reported area:
- replace missing data codes (e.g. "0") with missing data values (i.e. NA)
- replace protected areas represented as points with circular protected areas that correspond to their reported extent
- repair any topological issues with the geometries
- (erase overlapping areas) -> which might be important for area reporting on country level but is not done in our context here

For more information see the package documentation of `wdpar`. In the end of this step we will project the data back to WGS84 for the intersection.

```{r cleanWdpar, warning=FALSE, include=TRUE}
# clean the data
br_wdpa_subset <- wdpa_clean(
  br_wdpa_subset, 
  erase_overlaps = F
  )
# we can plot a feature of the data to see the three selected polygons
plot(br_wdpa_subset[1])
```
  
Since, we prepared WDPA polygon data for our analysis, we now load the TEOW global shapefile layer from archived file.

```{r loadTeow, warning=FALSE, include=TRUE}

# load TEOW global polygons
teow <- 
  read_sf(paste("data/Terrestrial_Ecoregions_World.shp", sep=""))

```

# Intersect TEOW and WDPA Polygon layer

To analyse how  much of wdpa area is within which part of the ecoregion, intersection function is applied. `st_intersection` allows us to see that result. To be able to apply st_intersection, the polygon layers should be saved as `sf` object. To carry out intersection function, coordinate reference system of both the polygons should be same. For this, we use `st_transform` to achieve this.

```{r intersect, warning=FALSE, include=TRUE}

# reproject teow to match WDPA
teow <-
  st_transform(teow,crs = st_crs(br_wdpa_subset))
# apply intersection
teow_wdpa_intersection <- 
  st_intersection(teow, br_wdpa_subset)
# plot intersection layer
plot(teow_wdpa_intersection[9])

```

We can see that there is one intersection for the polygon in the eastern part of the research area i.e that we now have four polygons whereas before the intersection we had only three. 


# Calculate Areas

Since, we already achieved the intersection, now we want to extract the actual area of intersection between wdpa polygons and teow polygons.

```{r extract, warning=FALSE, include=TRUE}

# extract areas (SqKm) and save it as new column
teow_wdpa_intersection$teow_intersect_sqkm <- 
  st_area(teow_wdpa_intersection)/1000000
# tibble - turns existing object to tibble dataframe from library `dplyr`
myData <- as_tibble(teow_wdpa_intersection)
# select only necessary columns from the intersected polygon
myData_f <- myData %>% 
  select(WDPAID, BIOME_NAME, teow_intersect_sqkm)
```
With the results looking like this

``````{r tableshow, warning=FALSE, echo=FALSE}
paged_table(myData_f)
```


In the end we are going to have a look how long the rendering of this file took so that people get an idea about the processing speed of this routine.

```{r time, warning=FALSE, include=TRUE}
stoptime<-Sys.time()
print(starttime-stoptime)
```
# References

[1] Olson, D. M., Dinerstein, E., Wikramanayake, E. D., Burgess, N. D., Powell, G. V. N., Underwood, E. C., D'Amico, J. A., Itoua, I., Strand, H. E., Morrison, J. C., Loucks, C. J., Allnutt, T. F., Ricketts, T. H., Kura, Y., Lamoreux, J. F., Wettengel, W. W., Hedao, P., Kassem, K. R. 2001. Terrestrial ecoregions of the world: a new map of life on Earth. Bioscience 51(11):933-938.