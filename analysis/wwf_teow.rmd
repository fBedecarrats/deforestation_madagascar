---
title: "Processing Terrestrial Ecoregions of the World(TEOW)"
author: "Johannes Schielein, Om Prakash Bhandari"
date: "3/12/2021"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_knit$set(root.dir = '../')
# load required libraries
library("sp")
library("sf")
library("wdpar")
library("dplyr")
library("rmapshaper")
library("rmarkdown")
library(tmap)
```

### Introduction

**Description of the dataset from WWF:**

Terrestrial Ecoregions of the World (TEOW) is a biogeographic regionalization of the Earth's terrestrial biodiversity. Our biogeographic units are ecoregions, which are defined as relatively large units of land or inland water containing a distinct assemblage of natural communities sharing a large majority of species, dynamics, and environmental conditions. There are 867 terrestrial ecoregions, classified into 14 different biomes such as forests, grasslands, or deserts. Ecoregions represent the original distribution of distinct assemblages of species and communities.Visit [Link]("https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world") for more information on TEOW from WWF.

Here we are going to carry out an analysis to see the level of intersection of different WDPA polygon layers with the Ecoregions; to answer how much area of wdpa polygon is within a particular type of ecoregion.

To carry out this analysis, we will follow this processing routine:

- fetch country level WDPA polygon from `wdpar`
- select desired wdpa polygon from `wdpar` and clean the data
- load archived global TEOW polygon
- simplify the TEOW polygon
- generate projstring using `area_proj` function & transform the projection system of polygons
- intersect TEOW and polygon layer
- extract areas of the intersection
- for each wdpaid, get name of the PA, ecoregion IDs, ecoregion names and area of intersected polygons


### WDPA polygon data preparation

First of all, we will try to get the country level polygon data from `wdpar` package. `wdpar` is a library to interface to the World Database on Protected Areas (WDPA). The library is used to monitor the performance of existing PAs and determine priority areas for the establishment of new PAs. We will use Brazil - for other countries of your choice, simply provide the country name or the ISO3 name e.g. Gy for Guyana, COL for Colombia

```{r fetchWdpar, warning=FALSE, include=TRUE}
# fetch the raw data from wdpar of country
br_wdpa_raw <- wdpa_fetch("Brazil")
```

Since there are more than 3000 enlisted protected areas in Brazil, we are interested in only three wdpa polygons:
  - Reserva Biologica Do Rio Trombetas - wdpaid 43,
	- Reserva Extrativista Rio Cajari - wdpaid 31776, and
	- Estacao Ecologica Do Jari - wdpaid 4891

For this, we have to subset the country level polygon data to the pa level.

```{r subset, warning=FALSE, include=TRUE}

# subset three wdpa polygons by their wdpa ids
br_wdpa_subset<-
  br_wdpa_raw%>%
  filter(WDPAID %in% c(43,4891,31776))
```


The next immediate step would be to clean the fetched raw data with the functionality provided by the `wdpar` package. Cleaning is done so as to:

- exclude protected areas that are not yet implemented
- exclude protected areas that are UNESCO reserves
- removing points with no reported area:
- replace missing data codes (e.g. "0") with missing data values (i.e. NA)
- replace protected areas represented as points with circular protected areas that correspond to their reported extent
- repair any topological issues with the geometries
- (erase overlapping areas) -> which might be important for area reporting on country level but is not done in our context here

For more information see the package documentation of `wdpar`. In the end of this step we will project the data back to WGS84 for the intersection.

```{r cleanWdpar, warning=FALSE, include=TRUE}
# clean the data
br_wdpa_subset <- wdpa_clean(
  br_wdpa_subset, 
  erase_overlaps = F
  )

#br_wdpa_subset <- st_transform(br_wdpa_subset, 4326)
```

### TEOW polygon data preparation
  
Since, we prepared WDPA polygon data for our analysis, we now load the TEOW global shapefile layer from archived file or if you want to download the teow global shapefile, you can download the file calling the function `get_wwf_teow`. 

```{r loadTeow, warning=FALSE, include=TRUE}

# load TEOW global polygons
teow <- read_sf(paste(getwd(),"/data/Terrestrial_Ecoregions_World.shp",sep=""))
# simplify geometry
teow_simp <- ms_simplify(teow)

```

### Intersect TEOW and WDPA Polygon layer

To analyse how  much of wdpa area is within  which part of the ecoregion, intersection function is applied. `st_intersection` allows us to see that result. To be able to apply st_intersection, the polygon layers should be saved as `sf` object. To carry out intersection function, coordinate reference system of both the polygons should be same. For this, we use `st_transform` to achieve this.

```{r intersect, warning=FALSE, include=TRUE}
## reproject teow to match WDPA
teow<-st_transform(teow,crs = st_crs(br_wdpa_subset))

teow_wdpa_intersection <- st_intersection(teow, br_wdpa_subset)
# plot intersection layer
tm_shape(teow_wdpa_intersection)+
  tm_polygons(teow,)
```

# Extract areas and required columns from the intersection layer

Since, we already achieved the intersection, now we want to extract the actual area of interaction between wdpa polygons and teow polygons.

```{r extract, warning=FALSE, include=TRUE}

# ectract areas (Sqkm) and save it as new column
teow_pol$Area_Sqm <- st_area(teow_pol)
# tibble - turns existing object to tibble dataframe from library `dplyr`
myData <- as_tibble(teow_pol)
# select only necessary columns from the intersected polygon
myData_f <- myData %>% 
  select(WDPAID, NAME, ECO_ID, ECO_NAME, Area_Sqm)
# view the data
myData_f
# with results looking like this in paged table format
paged_table(myData_f)
```