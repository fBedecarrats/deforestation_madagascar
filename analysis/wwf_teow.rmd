---
title: "Processing Terrestrial Ecoregions of the World(TEOW)"
author: "Johannes Schielein, Om Prakash Bhandari"
date: "3/12/2021"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_knit$set(root.dir = '../')
# load required libraries
library("sp")
library("sf")
library("wdpar")
library("dplyr")
library("rmapshaper")
library("rmarkdown")
library(tmap)
```



### Introduction

Terrestrial Ecoregions of the World (TEOW) is a biogeographic regionalization of the Earth's terrestrial biodiversity. Our biogeographic units are ecoregions, which are defined as relatively large units of land or inland water containing a distinct assemblage of natural communities sharing a large majority of species, dynamics, and environmental conditions. There are 867 terrestrial ecoregions, classified into 14 different biomes such as forests, grasslands, or deserts. Ecoregions represent the original distribution of distinct assemblages of species and communities.Visit [Link]("https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world") for more information on TEOW from WWF.

Here we are going to carry out an analysis to see the level of intersection of different WDPA polygon layers with the Ecoregions; to answer how much area of wdpa polygon is within a particular type of ecoregion.

To carry out this analysis, we will follow this processing routine:

- fetch country level WDPA polygon from `wdpar`
- select desired wdpa polygon from `wdpar` and clean the data
- load archived global TEOW polygon
- simplify the TEOW polygon
- generate projstring using `area_proj` function & transfrom the projection system of polygons
- intersect TEOW and polygon layer
- extract areas of the intersection
- for each wdpaid, get name of the PA, ecoregion IDs, ecoregion names and area of intersected polygons


### WDPA polygon data preparation

First of all, we will try to get the country level polygon data from `wdpar` package. `wdpar` is a library to interface to the World Database on Protected Areas (WDPA). The library is used to monitor the performance of existing PAs and determine priority areas for the establishment of new PAs. We will use Brazil - for other countries of your choice, simply provide the country name or the ISO3 name e.g. Gy for Guyana, COL for Colombia

```{r fetchWdpar, warning=FALSE, include=TRUE}
# fetch the raw data from wdpar of country
br_raw_pa_data <- wdpa_fetch("Brazil")
```

Since there are more than 3000 enlisted protected areas in Brazil, we are interested in only three wdpa polygons:
  - Reserva Biologica Do Rio Trombetas - wdpaid 43,
	- Reserva Extrativista Rio Cajari - wdpaid 31776, and
	- Estacao Ecologica Do Jari - wdpaid 4891

For this, we have to subset the country level polygon data to the pa level.

```{r subset, warning=FALSE, include=TRUE}

# subset three wdpa polygons by their wdpa ids
bra<-
  br_raw_pa_data%>%
  filter(WDPAID %in% c(43,4891,31776))
```


The next immediate step would be to clean the fetched raw data. Cleaning is done so as to:

- exclude protected areas that are not yet implemented
- exclude protected areas with limited conservation value
- replace missing data codes (e.g. "0") with missing data values (i.e. NA)
- replace protected areas represented as points with circular protected areas that correspond to their reported extent
- repair any topological issues with the geometries
- erase overlapping areas

```{r cleanWdpar, warning=FALSE, include=TRUE}

# clean the data
brac <- wdpa_clean(bra)
# spatial 
brac_sp <- as(brac, "Spatial")
```

In order to generate area statistics, it is important to reproject the polygons from geographic coordinate system to the projected coordinate system. Since we want to preserve the area for this analysis, we will be using Lambert Azimuthal Equal Area Projection. To check the projstring for the desired area of the selection, we call the function `area_proj` which generates projstring for the supplied feature extent.

At first you should link to the source functions to go through this particular step.
```{r source, include=TRUE}
source("../code/area_proj.R")
```

Now, call the function to get the required projstring parameters. The function `area_proj` however only accept `sf` object.

```{r areaProj, warning=FALSE, include=TRUE}

# # SpatialPolygonsDataFrame for sf compatibility
brac_sf <- st_as_sf(brac_sp)
# apply function
area_proj(brac_sf)
```
Now, we will use the above obtained projstring parameters to project our polygon.

```{r transform, warning=FALSE, include=TRUE}

# set desired projection to myCrs
myCrs <- "+proj=laea +lat_0=-103494 +lon_0=-5238465 +x_0=59069094000 +y_0=19274928000 +a=6371007.181 +b=6371007.181 +units=m +no_defs"
# transforn the wdpa polygon to the desired projection system
#bra_sft <- st_transform(brac_sf, st_crs(myCrs))
```

### TEOW polygon data preparation

Since, we prepared WDPA polygon data for our analysis, we now load the TEOW global shapefile layer from archived file or if you want to download the teow global shapefile, you can download the file calling the function `get_wwf_teow`. 

```{r loadTeow, warning=FALSE, include=TRUE}

# load TEOW global polygons
teow <- read_sf("../data/Terrestrial_Ecoregions_World.shp")
# simplify geometry
teow_simp <- ms_simplify(teow)
# SpatialPolygonsDataFrame for sp compatibility
teow_sp <- as(teow_simp, "Spatial")
```



### Intersect TEOW and WDPA Polygon layer

To analyse how  much of wdpa area is within  which part of the ecoregion, intersection function is applied. `st_intersection` allows us to see that result. To be able to apply st_intersection, the polygon layers should be saved as `sf` object. To carry out intersection function, coordinate reference system of both the polygons should be same. For this, we use `st_transform` to achieve this.

```{r intersect, warning=FALSE, include=TRUE}

# SpatialPolygonsDataFrame for sf compatibility
teow_sf <- st_as_sf(teow_sp)
# project wdpa polygon to teow
brac_ex <- st_transform(brac_sf, st_crs(teow_sf))
# intersection
teow_pol <- st_intersection(teow_sf, brac_ex)
# plot intersection layer
tm_shape(teow_pol)+
  tm_polygons()
```

# Extract areas and required columns from the intersection layer

Since, we already achieved the intersection, now we want to extract the actual area of interaction between wdpa polygons and teow polygons.

```{r extract, warning=FALSE, include=TRUE}

# ectract areas (Sqkm) and save it as new column
teow_pol$Area_Sqm <- st_area(teow_pol)
# tibble - turns existing object to tibble dataframe from library `dplyr`
myData <- as_tibble(teow_pol)
# select only necessary columns from the intersected polygon
myData_f <- myData %>% 
  select(WDPAID, NAME, ECO_ID, ECO_NAME, Area_Sqm)
# view the data
myData_f
# with results looking like this in paged table format
paged_table(myData_f)
```