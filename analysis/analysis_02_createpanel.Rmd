---
title: "Panel creation"
author: "Yota"
date: "28 3 2022"
output: workflowr::wflow_html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/shared/datalake/mapme.protectedareas")
```


```{r}
# clean workspace, set options
rm(list=ls())
options(scipen=999)

# get packages
lop <- c("tidyverse")
newp <- lop[!(lop %in% installed.packages()[,"Package"])]
if(length(newp)) install.packages(newp)
lapply(lop, require, character.only = TRUE)

```

```{r}
#------- Load and prepare fc data -------

# Forest loss data
fcl_supported_AND_nonPas <-
  read_csv("../../datalake/mapme.protectedareas/output/polygon/sampling/fishnets/dec_08/gfw/gfw_10km_all.csv")

# Select variables
fcl_data <- fcl_supported_AND_nonPas %>% 
  select(poly_id,id.x,treatment.x, starts_with("area"), starts_with("loss"))
```

```{r}
#------- Select years and prepare table -------

# Years with matching frames:
T_year <- c(2003:2020)

for (i in T_year) {
  
  tryCatch({
  
    # Load matched data
    m_data <- 
        read_csv(paste0("../../datalake/mapme.protectedareas/output/tabular/regression_input/PSM/ps_matched_data_", i, ".csv"))
    
    # Merge matched data with 
        merged_data <- 
          left_join(m_data, fcl_data,
                                 by=c("poly_id")) %>% 
          pivot_longer(cols = c(starts_with("area") | starts_with("loss")),
                       names_to = c(".value", "year"),
                       names_sep = "_") %>% 
          select(-id.x, -treatment.x) %>% 
          mutate(year_standard = as.numeric(year) - i) %>% 
          rename("fc_area" = "area",
                 "fc_loss" = "loss")
        
    ## Export data
    write_csv(merged_data, 
              paste0("../../datalake/mapme.protectedareas/output/tabular/regression_input/PSM/ps_matched_panel_", i, ".csv"))
  
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
    
}
```

