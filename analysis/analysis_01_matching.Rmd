---
title: "Matching"
author: "Yota"
date: "28 3 2022"
output: workflowr::wflow_html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::opts_knit$set(root.dir = "~/shared/datalake/mapme.protectedareas")
```


```{r include=FALSE}
# clean workspace, set options
rm(list=ls())
options(scipen=999)

# get packages
lop <- c("dplyr", "plm", "stargazer", "tidyverse", "MatchIt", "glm", "optmatch", "cobalt", "gridExtra")
newp <- lop[!(lop %in% installed.packages()[,"Package"])]
if(length(newp)) install.packages(newp)
lapply(lop, require, character.only = TRUE)

```


```{r Propensity Score Matching (PSM), echo=TRUE}
#------- Select years and prepare table -------

# Years with matching frames. Years without treatment starting years (no BMZ number started in these years) 2003, 2017, 2018, 2020
T_year <- c(2004:2016, 2019)

T_year <- c(2015)
for (i in T_year) {
  
  #------- Load matching frames -------
  #file <- paste0("matching_frame_",i)
  df <- 
    read_csv(paste("./output/matching/matching_frames/matching_frame_",i,".csv", sep = "")) %>% 
    select(id, poly_id, treatment, everything())
  
   df <- df %>% 
    filter(! is.na(country),
           ! is.na(clay_content_10_cm))
   
  #------- NN PS matching w/ replacement and exact matching 'country'-------
  
  tryCatch({
    
    # Get propensity scores
    glm_out1 <- glm(treatment ~ 
                     travel_time_to_nearby_cities_min_20l_100mio + 
                     clay_content_10_cm + 
                     terrain_ruggedness_index_mean +
                     elevation_mean + 
                     as.factor(country) +
                     fc_area_matchingyear +
                     sum_fcl_matchingyear_tmax,
                   family = binomial(link = "probit"), 
                   data = df)
      
    
    stargazer(glm_out1,
              summary=TRUE,
              type="text",
              title = paste0("Probit regression for matching frame ",i),
              out = paste0("../../datalake/mapme.protectedareas/output/plots/propensity_score_matching/probit_summary_",i,".html"))
    
  
    m_out1 <- matchit(treatment ~
                        travel_time_to_nearby_cities_min_20l_100mio +
                        clay_content_10_cm +
                        terrain_ruggedness_index_mean +
                        elevation_mean +
                        as.factor(country) +
                        fc_area_matchingyear +
                        sum_fcl_matchingyear_tmax,
                      data = df,
                      method = "nearest",
                      replace = TRUE,
                      exact = ~ as.factor(country),
                      distance = "glm", 
                      discard = "both", # common support: drop units from both groups 
                      link = "probit")
    
    print(m_out1)
    print(summary(m_out1, un = FALSE))
    
    # Balance table
    bal_table <- bal.tab(m_out1, un = TRUE)
    print(bal_table)
    
    
    # Matched data
    m_data1 <- match.data(m_out1)
    
    ## Export data
    write_csv(m_data1, 
          paste0("../../datalake/mapme.protectedareas/output/tabular/regression_input/PSM/ps_matched_data_", i, ".csv"))
  
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
}
```

```{r Coarsened Exact Matching (CEM), echo=TRUE}
# Years with matching frames. Years without treatment starting years (no BMZ number started in these years) 2003, 2017, 2018, 2020
T_year <- c(2004:2016, 2019)
T_year <- c(2015)
# Load cutpoints (use cutpoints from dummy CEM matching for 2015)
cutoffs_list <- readRDS("../../datalake/mapme.protectedareas/output/tabular/regression_input/CEM/cem_cutpoints.rds")

for (i in T_year) {
  
  #------- Load matching frames -------
  
  df <- 
    read_csv(paste("./output/matching/matching_frames/matching_frame_",i,".csv", sep = "")) %>% 
    select(id, poly_id, treatment, everything())
  
  
  # Prepare df for matching (no NA allowed)
  df_match <- df %>% 
    filter(! is.na(country),
           ! is.na(clay_content_10_cm))
  
  #------- Perform CEM -------
  
  tryCatch({
    
    m_out2 <- matchit(treatment ~
                        travel_time_to_nearby_cities_min_20l_100mio +
                        clay_content_10_cm +
                        terrain_ruggedness_index_mean +
                        elevation_mean +
                        as.factor(country) +
                        fc_area_matchingyear +
                        sum_fcl_matchingyear_tmax,
                      data = df_match,
                      method = "cem",
                      cutpoints = cutoffs_list)
    
    # Matching summary
    print(m_out2)
    print(summary(m_out2, un = FALSE))
    
    # Balance table
    bal_table <- bal.tab(m_out2, un = TRUE)
    print(bal_table)
    
    # Matched data
    m_data2 <- match.data(m_out2) 
    
    ## Export data
    write_csv(m_data2, 
              paste0("../../datalake/mapme.protectedareas/output/tabular/regression_input/CEM/ce_matched_panel_", i, ".csv"))
    
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
  
}

```

