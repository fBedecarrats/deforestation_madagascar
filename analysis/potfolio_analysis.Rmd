---
title: "KfW Protected Areas Portfolio Analysis"
author: "Johannes Schielein"
date: "2021-05-04"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, message = FALSE,warning = FALSE,include = FALSE}
# load relevant libraries
library("tidyverse")
library("readxl")
library("janitor")
library("sf")
library("leaflet")
library("RColorBrewer")
library("plotly")
```

```{r database_creation, message = FALSE, warning = FALSE, include = FALSE}
##  Protected areas
wdpa_kfw<-
  read_sf("data/wdpa_kfw_spatial_latinamerica_2021-04-22_allPAs.gpkg")

#  Filter for supported areas
wdpa_kfw_treatment<-
  wdpa_kfw%>%
  filter(bmz_n_1>0)

## ---- TEOW ----
db_teow<-rbind(read_csv("~/shared/datalake/mapme.protectedareas/output/polygon/teow/teow_long_allPAs_merged_biome.csv"),
               read_csv("~/shared/datalake/mapme.protectedareas/output/polygon/teow/teow_long_allPAs_merged_eco.csv"))

## ---- GLOBAL MANGROVE WATCH ---


```

## Introduction
Conservation finance is an important field in the KfW development bank with considerable investment into Protected Areas (Short PAs). The evaluation department, together with operational departments tries to learn more about our conservation projects by using internal data as well as open geo-data to assess the relevance and effectiveness of supported areas in Latin America. The main impact goals of our conservation financing efforts can be summarized under three broad topics: 

1. Conservation of biological diversity
2. Mitigation of global climate change e.g by reducing deforestation
3. Improvement of livelihoods of the local population that uses the natural resources

Conservation finance has increased in importance for German development cooperation and considerably more financial resources had been spent in Latin America since 2004. 

```{r financeplot, echo=FALSE, message=FALSE, warning=FALSE}
kfw_finance<-read_csv("~/shared/datalake/mapme.protectedareas/input/kfw/mapme.protectedareas_kfw-finance_complete-2021-03-17.csv")

finance_plot <-
  kfw_finance %>%
  group_by(year) %>%
  summarize(total_disbursed = sum(disbursement_total)) %>%
  filter(year != 2021) %>%
  ggplot() +
  geom_bar(aes(x = year, y = total_disbursed / (10 ^ 6)),
           stat = "identity",
           fill = "darkblue") +
  labs(y = "Disbursements (Mio. â‚¬)", x = "", fill = "") +
  theme_classic()

ggplotly(finance_plot)

```
We machted our Latin America portfolio with the *World Database on Protected Areas - WDPA* (IUCN) and used data from the multiple different open data-sources to make an assessment of our portfolio and evaluate the impacts of our projects. Our database currently comprises `r nrow(wdpa_kfw_treatment)` PAs in Latin America which are situated in `r length(unique(wdpa_kfw_treatment$ISO3))` different countries. Those areas can be broadly categorized into `r table(wdpa_kfw_treatment$MARINE)[[3]]` terrestrial, `r table(wdpa_kfw_treatment$MARINE)[[1]]` marine, and `r table(wdpa_kfw_treatment$MARINE)[[2]]` partial marine/terrestrial protected areas. They cover a total surface of `r round(sum(st_area(wdpa_kfw_treatment))/(10^12),digits=3)` Mio. km^2^ which is about `r round(sum(st_area(wdpa_kfw_treatment))/(10^9)/357.581,digits=1)` times the size of Germany. 

```{r firstmap, echo=FALSE, warning=FALSE}
wdpa_kfw_treatment_centroid<-wdpa_kfw_treatment %>%
  filter(!is.na(MARINE))%>%
  st_centroid()

# create colorramp
pal <- colorFactor(
  palette = c("darkblue","orange","darkgreen"),
  domain = wdpa_kfw_treatment_centroid$MARINE
)

# add map
wdpa_kfw_treatment_centroid<-st_transform(st_centroid(wdpa_kfw_treatment_centroid),crs = 4326)
my_map <-
  leaflet(data = wdpa_kfw_treatment_centroid) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircles(opacity = 0.9,color = ~pal(MARINE))%>%
  addLegend("bottomright", pal = pal, values = ~MARINE,
    title = "Area Types",
    opacity = 1
  )
my_map

```


## Ecoregions and Biomes
```{r teow_prepare_data, message = FALSE, warning = FALSE, include = FALSE}
# clean and prepare database
db_teow_ecosystems <-
  db_teow %>%
  filter(grepl('teow_intersect_sqkm_', name))

db_teow_biomes <-
  db_teow %>%
  filter(grepl('biome_intersect_sqkm_', name))

# clean and prepare database for KfW areas only
db_teow_ecosystems_kfw <-
  db_teow %>%
  filter(grepl('teow_intersect_sqkm_', name)) %>%
  filter(WDPAID %in% wdpa_kfw_treatment$WDPAID)

db_teow_biomes_kfw <-
  db_teow %>%
  filter(grepl('biome_intersect_sqkm_', name)) %>%
  filter(WDPAID %in% wdpa_kfw_treatment$WDPAID)


```
Conservation planning needs careful consideration on how to allocate limited financial resources in order to preserve the most relevant, remaining natural landscapes. In order to put money to work where it is most urgently needed, targeted ares should be high in biodiversity and endemism, as well as ecosystem functionality (and the degree to which they are threatened). Therefore, we need to use an adequate conceptual model that characterizes different natural areas in terms of biodiversity and ecosystem functionality. This will allow us to see how our financial resources are allocated among distinctive biotas and if we have an overall bias towards specific ecosystems while other relevant areas slip our attention. 

To that end we utilize the *Terrestrial Ecoregions of the World (TEOW)* classification system from Olson et al..^[REF - Olson et al: https://academic.oup.com/bioscience/article/51/11/933/227116] The *TEOW* system is based on biogeographic knowledge from thousands of experts and designed with the purpose of conservation planning in mind. It differentiates between 867 ecoregions which are nested in 14 large biomes. Ecoregions are defined as *relatively large units of land containing a distinct assemblage of natural communities and species, with boundaries that approximate the original extent of natural communities prior to major land-use change* (Olson et al.). Each ecoregion is part of a terrestrial biome which is a major ecosystem division that shares a common climate, vegetation type (e.g. tundra or forest), soiltype and wildlife. 

KfW supports PAs that cover `r length(unique(db_teow_ecosystems_kfw$name))` different ecosystems and `r length(unique(db_teow_biomes$name))` biomes. This corresponds to `r round(length(unique(db_teow_ecosystems_kfw$name))/length(unique(db_teow_ecosystems$name))*100,digits=0)`% of all terrestrial ecoregions in our `r length(unique(wdpa_kfw_treatment$ISO3))` partnering countries. This relatively high share indicates a broad diversification of the investment portfolio. Nevertheless we should compare total area size of supported ecoregions to get a more adequate representation of the utilized funds:









```{r}

```


```{r}

```


```{r}

```


```{r}

```


```{r}

```

