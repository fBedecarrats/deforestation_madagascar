---
title: "Net Forest Carbon Flux"
author: "Johannes Schielein, Om Bhandari"
date: "3/5/2021"
output: html_document
---

```{r setup, message=FALSE}
knitr::opts_knit$set(root.dir = '../')
# load required libraries
library("sp")
library("raster")
library("sf")
library("wdpar")
library("dplyr")

```


### Introduction

Forest Carbon Emissions are GHG emissions that originate from forest cover loss and subsequent Above Ground Biomass and Below Ground Biomass loss. Net forest carbon flux represents the net exchange of carbon between forests and the atmosphere. Forest act as both a Source and Sink for Carbon. 


To calculate zonal statistics for net forest carbon flux that changed between 2001 to 2019, enlisted is the required processing routine:
  
  - Download raster data of the desired grid using function `get_net_carbon_flux`
  - Fetch country level wdpa data from library `wdpar`
  - Select desired wdpa polygon from wdpa data
  - Clean the data
  - Clip the carbon_flux raster by the selected polygon to its extent and mask layer
  - Rasterize the selected polygon area
  - Perform zonal statistics


### Raster data preparation

At first you should link to the source functions to go through this routine.
```{r source, include=TRUE}
source("code/carbon-flux.R")
```


How to use the function?

- you can call the function `get_net_carbon_flux` by passing (lat, lon) arguments as string for eg. ("10S", "050W") or ("10N", "020E")
- you should check the coordinates of your desired area and need to find out the grid under which interval of latitude and longitude does it fall
- or simply visit the [GFW Dataset Portal](https://data.globalforestwatch.org/datasets/net-forest-carbon-flux/data) to verify chosen grid coordinates
- Note: If in case you choose to compute zonal statistics for larger polygon level or for many polygon levels, then one raster data might not be enough for your computation. Then you must download multiple raster files so as to cover the polygon extent and merge them later simply using `merge` function.


```{r callFunction, warning=FALSE, include=TRUE}
options(timeout=180) # sets timeout for downloads to 180seconds
# call the function to download raster for a part of the country Brazil where we want to compute zonal statistics
# Note: raster value is 'Mg_CO2_ha-1'
myRaster <- 
  get_net_carbon_flux("00N", "060W")
```

After successfully running this function, you can see that the raster file is stored in the temporary directory of R, which we can see above within double quote. For the next step, simply pass the returned temporary file path from the 'callFunction' chunk to the 'loadRaster' chunk so as to load the downloaded raster file.

```{r loadRaster, warning=FALSE, include=TRUE}
# view raster metadata
myRaster
# plot the raster
plot(myRaster)
```

### Polygon data preparation

Since we already prepared raster data for our analysis. Now, we will try to get the country level polygon data from `wdpar` package. `wdpar` is a library to interface to the World Database on Protected Areas (WDPA). The library is used to monitor the performance of existing PAs and determine priority areas for the establishment of new PAs. We will use Brazil - for other countries of your choice, simply provide the country name or the ISO name e.g. Gy for Guyana, COL for Colombia

```{r fetchWdpar, warning=FALSE, include=TRUE}
# fetch the raw data from wdpar of country
br_raw_pa_data <- wdpa_fetch("Brazil")
```

Since there are more than 3000 enlisted protected areas in Brazil, we want to compute zonal statistics only for the polygon data of:
  - Reserva Biologica Do Rio Trombetas - wdpaid 43,
	- Reserva Extrativista Rio Cajari - wdpaid 31776, and
	- Estacao Ecologica Do Jari - wdpaid 4891

For this, we have to subset the country level polygon data to the pa level.

```{r subset, warning=FALSE, include=TRUE}

# subset three wdpa polygons by their wdpa ids
bra<-
  br_raw_pa_data%>%
  filter(WDPAID %in% c(43,4891,31776))
```


The next immediate step would be to clean the fetched raw data. Cleaning is done so as to:
- exclude protected areas that are not yet implemented
- exclude protected areas with limited conservation value
- replace missing data codes (e.g. "0") with missing data values (i.e. NA)
- replace protected areas represented as points with circular protected areas that correspond to their reported extent
- repair any topological issues with the geometries
- erase overlapping areas

```{r cleanWdpar, warning=FALSE, include=TRUE}

# clean the data
brac <- wdpa_clean(bra)
# spatial 
brac_sp <- as(brac, "Spatial")
```



### Crop the Carbon Flux Raster

As we completed raster and vector data preparation, the next step would be to clip the raster layer by the selected shapefile polygon both by its extent and mask layer.

```{r cropRaster, warning=FALSE, include=TRUE}

# extent preparation
myExtent <- spTransform(brac_sp, CRS(proj4string(myRaster)))
# plot the extent that will be used to crop the raster layer
plot(myExtent)
# crop raster using polygon extent
myCrop <- crop(myRaster, myExtent)
# plot the data - shows the raster after getting cropped by the extent of polygon
plot(myCrop)
# crop raster using polygon mask
myMask <- mask(myCrop, myExtent)
# plot the data - shows the raster after getting cropped by the polygon mask
plot(myMask)
```



### Rasterize the polygon layer

To compute the zonal statistics, it is necessary to rasterize the polygon layer. Doing so, values are transferred from the spatial objects to raster cells. We need to pass the extent layer and the mask layer to the rasterize function.

```{r rasterize, warning=FALSE, include=TRUE}

# rasterize
r <- rasterize(myExtent, myMask, myExtent$WDPAID, background=NA, update=FALSE, touches=is.lines(myExtent), cover=FALSE)
```


### Compute zonal statistics

A zonal statistics operation is one that calculates statistics on cell values of a raster (a value raster) within the zones defined by another dataset [ArcGIS definition].

```{r zoneStats, warning=FALSE, include=TRUE}

# zonal stats
zstats <- zonal(myMask, r, fun='sum', na.rm=T)
zstats
```
By mathematical definition, net forest carbon flux is the difference between average annual gross emissions and average annual gross removals. Hence, positive result denotes forests as net sources of carbon and negative results denotes forests as net sinks of carbon.

For all the three polygons we considered, we got the negative result. That means forests in these three Protected Areas act as the net sinks of carbon.
